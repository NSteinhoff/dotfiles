#!/bin/bash
############################
# install
# This script creates symlinks from the home directory to any desired dotfiles in ~/dotfiles
############################
dir=$(pwd)

########## Installing system packages
echo -e "\n\n"
echo ">>>>>>>>>>>>>>>"
echo "Installing system packages..."

sudo apt install $(cat $dir/extras/packages)


##### Installing Python
install_python=false
if $install_python; then
    echo -e "\n\n"
    echo ">>>>>>>>>>>>>>>"
    echo "Installing python..."

    $dir/extras/python
fi


########## ZSH
install_zsh=false
if $install_zsh; then
    tput setaf 3
    echo "Making Zsh default shell"
    sudo chsh -s `which zsh`
    echo "Installing oh-my-zsh"
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
    tput sgr0
fi

########## Dotfiles in HOME
echo -e "\n\n"
echo ">>>>>>>>>>>>>>>"
echo "Installing dotfiles..."
bkpdir=~/.dotfiles_bkp
files=(inputrc vimrc vim git_template screenrc gitconfig gitignore tmux.conf zshrc bash_aliases crawlrc ctags ctags.d scalafmt.conf cider.edn)

# create dotfiles_old in homedir
echo "Creating $bkpdir for backup of any existing dotfiles in ~ ..."
mkdir -p $bkpdir

# change to the dotfiles directory
echo "Changing to the $dir directory ..."
cd $dir

# move any existing dotfiles in homedir to dotfiles_old directory, then create symlinks from the homedir to any files in the ~/dotfiles directory specified in $files
for file in ${files[*]}; do
    if [ -L ~/.$file ]; then
        tput setaf 3
        echo -n "Removing old symlink; "
        rm ~/.$file
        tput sgr0
    fi
    if [ -f ~/.$file ] || [ -d ~/.$file ]; then
        tput setaf 3
        echo -n "Moving existing file; "
        mv -v ~/.$file $bkpdir/$file
        tput sgr0
    fi
    tput setaf 2
    echo -n "Creating symlink: "
    tput sgr0
    ln -v -s $dir/$file ~/.$file
done

########## Configurations in ~/.config
echo -e "\n\n"
echo ">>>>>>>>>>>>>>>"
echo "Installing config files..."

cfgdir=$dir/config
cfgbkpdir=~/.config/backup_$(date +%F-%T)
files=(alacritty/alacritty.yml sxhkd/sxhkdrc nvim)

# create dotfiles_old in homedir

# change to the dotfiles directory
echo "Changing to the $cfgdir directory ..."
cd $cfgdir

# move any existing dotfiles in homedir to dotfiles_old directory, then create symlinks from the homedir to any files in the ~/dotfiles directory specified in $files
for file in ${files[*]}; do
    target="$cfgdir/$file"
    linkname="$HOME/.config/$file"
    linkdir="${linkname%/*}"
    if [ -L "$linkname" ]; then
        tput setaf 3
        echo -n "Removing old symlink; "
        rm "$linkname"
        tput sgr0
    fi
    if [ -f "$linkname" ] || [ -d "$linkname" ]; then
        tput setaf 3
        echo -n "Backing-up existing file; "
        mkdir -p "$cfgbkpdir/${file%/*}"
        mv -v "$linkname" "$cfgbkpdir/$file"
        tput sgr0
    fi
    tput setaf 2
    echo -n "Creating symlink: "
    tput sgr0
    [ -f "$linkdir" ] || mkdir -p "$linkdir"
    ln -v -s "$target" "$linkname"
done


# Init and update the plugins tracked as submodules
git submodule update --init --recursive


### Download git prompt script
# curl -XGET "https://raw.githubusercontent.com/git/git/master/contrib/completion/git-prompt.sh" > ~/.git-prompt.sh
