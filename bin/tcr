#!/bin/bash
if [ $# -gt 1 ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    cat <<END
usage: tcr [command]

Runs tests and commits the change when the tests pass.
Otherwise reverts to the last passing state.

    command         Test command.
                    default: "make test"

    -h, --help      Show this help.
END
    exit 0
fi

stamp="$(git rev-parse --show-toplevel)/.tcr-stamp"

# Parse args
test_cmd="${1:-make test}"

check_changes () {
    DIFF="$(git diff --no-color)"
    if [ "$DIFF" = "" ]; then
        echo -e  "\n>>>>> No changes! <<<<<\n"
    else
        echo "Changes to be tested:"
        echo -e "\n>>>>>"
        git --no-pager diff
        echo -e "<<<<<\n"
    fi
}

confirm () {
    echo -e "Testing: $test_cmd\n---"
    read -p "Press any key to continue. ESC to cancel! " -s -N 1 KEY
    echo

    if [ "$KEY" = $'\e' ]; then
        confirmed=false
        echo -e "\nOK then :(\n"
    else
        confirmed=true
        echo -e "\nLet's go! :)\n"
    fi
}

notify () {
    status=$?
    [ -n "$which notify-send" ] || exit

    if [ $status != 0 ]; then
        notify-send -i "error" "TCR FAILED"
    fi
}

run_tcr () {
    # Assemble the command string
    test="$test_cmd"
    commit="(git commit -am 'passing' || true)"  # ignore exit code when nothing to commit
    revert="git reset --hard"
    touch="(git ls-files | xargs touch)"         # touch the files to make vim 'autoread' work
    full_cmd="($test && $commit && exit 0) || ($revert && $touch && exit 1)"

    sh -c "$full_cmd"

    notify
}

check_changes
confirm
$confirmed && run_tcr || [ -n $(which notify-send)alert "TCR tests failed"

echo 'done' > "$stamp"
