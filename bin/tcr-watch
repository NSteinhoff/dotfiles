#!/bin/sh
if [ $# -gt 1 ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    cat <<END
usage: test-and-commit-or-revert [command]

Runs tests when a file tracked by git is changed and commits
the change when the tests pass. Otherwise reverts to the last
passing state.

    command         Test command.
                    default: "make test"

    -h, --help      Show this help.
END
    exit 0
fi


stamp='.tcr-stamp'

test_cmd="${1:-make test}"
echo "Testing: $test_cmd\n---"

# Assemble the command string
test="$test_cmd"
commit="(git commit -am 'passing' || true)"  # ignore exit code when nothing to commit
revert="git reset --hard"
touch="(git ls-files | xargs touch)"         # touch the files to make vim 'autoread' work
full_cmd="($test && $commit) || ($revert && $touch)"

git ls-files | entr -s "$full_cmd; touch $stamp"
