#!/bin/sh
if [ $# -gt 1 ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    cat <<END
usage: test-and-commit-or-revert [command]

Runs tests when a file tracked by git is changed and commits
the change when the tests pass. Otherwise reverts to the last
passing state.

    command         Test command.
                    default: "make test"

    -h, --help      Show this help.
END

else
    test_cmd="${1:-make test}"

    tput setaf 3
    echo "Testing: $test_cmd\n---"
    tput sgr0

    # Assemble the command string
    test="$test_cmd"
    commit="(git commit -am 'passing' || true)"  # ignore exit code when nothing to commit
    revert="git reset --hard"
    tell_succes="tput setaf 2; echo Tests passed! Commit!; tput sgr0"
    tell_failure="tput setaf 1; echo Tests failed! Revert!; tput sgr0"
    full_cmd="($test && ($tell_succes; $commit)) || ($tell_failure; $revert)"

    git ls-files | entr sh -c "$full_cmd"
fi
