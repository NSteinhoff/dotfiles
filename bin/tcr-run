#!/bin/sh
if [ $# -gt 1 ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    cat <<END
usage: test-and-commit-or-revert [command]

Runs tests and commits the change when the tests pass.
Otherwise reverts to the last passing state.

    command         Test command.
                    default: "make test"

    -h, --help      Show this help.
END
    exit 0
fi

# Parse args
test_cmd="${1:-make test}"

check_changes () {
    DIFF="$(git diff --no-color)"
    if [ "$DIFF" = "" ]; then
        echo No changes!
        exit 0
    fi

    echo "Changes to be tested:"
    tput setaf 3
    echo "\n>>>>>"
    echo "$DIFF"
    echo "<<<<<\n"
    tput sgr0
}

confirm () {
    echo "Testing: $test_cmd\n---"
    read -p "Continue (y/n)? " CONFIRM

    if [ $CONFIRM = "n" ]; then
        echo "OK then."
        exit 0
    fi
}

run_tcr () {
    # Assemble the command string
    test="$test_cmd"
    commit="(git commit -am 'passing' || true)"  # ignore exit code when nothing to commit
    revert="git reset --hard"
    touch="(git ls-files | xargs touch)"         # touch the files to make vim 'autoread' work
    full_cmd="($test && $commit) || ($revert && $touch)"

    sh -c "$full_cmd"
}

check_changes
confirm
run_tcr
